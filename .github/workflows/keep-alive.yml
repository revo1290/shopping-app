# Keep Render backend alive by sending periodic health checks
# Render free tier spins down after 15 minutes of inactivity

name: Keep Alive

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping backend health endpoint
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ö†Ô∏è BACKEND_URL secret is not set. Please set it in repository settings."
            echo "Expected format: https://your-app.onrender.com"
            exit 0
          fi
          
          echo "üè• Pinging health endpoint: ${BACKEND_URL}/api/health"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${BACKEND_URL}/api/health" || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Backend is healthy (HTTP $RESPONSE)"
          elif [ "$RESPONSE" = "000" ]; then
            echo "‚ö†Ô∏è Backend is starting up or unreachable (timeout)"
            # Try again after a short wait (Render cold start can take ~30s)
            sleep 10
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 "${BACKEND_URL}/api/health" || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Backend is now healthy after cold start (HTTP $RESPONSE)"
            else
              echo "‚ùå Backend still unreachable (HTTP $RESPONSE)"
            fi
          else
            echo "‚ö†Ô∏è Unexpected response (HTTP $RESPONSE)"
          fi
